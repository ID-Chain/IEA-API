version: '3'

networks:
  indy-network:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: ${API_SUBNET-172.16.0.0/24}

services:
  pool:
    image: idchain/testpool
    ports:
      - ${POOL_PORTS-9701-9708}:${POOL_PORTS-9701-9708}
    environment:
      - POOL_NAME
      - POOL_IP
      - PORTSTART
    networks:
      indy-network:
        ipv4_address: ${POOL_IP}

  mongodb:
    image: mongo:4
    command: --smallfiles
    environment:
      - MONGO_INITDB_ROOT_USERNAME=${DB_USER}
      - MONGO_INITDB_ROOT_PASSWORD=${DB_PASSWORD}
    networks:
      - indy-network

  schemac:
    image: idchain/schemacompiler
    environment:
      - SCHEMA_COMP_HOST
      - SCHEMA_COMP_PORT
    networks:
      indy-network:
        ipv4_address: ${SCHEMA_COMP_HOST}

  api:
    build:
      context: .
    image: idchain/api
    container_name: idchain-api
    environment:
      - IDCHAIN_APP_HOST
      - IDCHAIN_APP_PORT
      - IDCHAIN_APP_DOMAIN_PROTOCOL
      - IDCHAIN_APP_DOMAIN_HOST
      - IDCHAIN_APP_DOMAIN_PORT
      - IDCHAIN_APP_NYM_ALWAYS
      - IDCHAIN_JWT_SECRET
      - IDCHAIN_DB_HOST
      - IDCHAIN_DB_PORT
      - IDCHAIN_DB_USER
      - IDCHAIN_DB_PASSWORD
      - IDCHAIN_SALTROUNDS
      - POOL_IP
      - POOL_NAME
      - IDCHAIN_GENESIS_TXN
      - IDCHAIN_LOG_LEVEL
      - RUST_LOG
      - SCHEMA_COMP_HOST
      - SCHEMA_COMP_PORT
    ports:
      - ${IDCHAIN_APP_PORT}:${IDCHAIN_APP_PORT}
    depends_on:
      - mongodb
      - pool
      - schemac
    networks:
      indy-network:
        ipv4_address: ${IDCHAIN_APP_HOST}
